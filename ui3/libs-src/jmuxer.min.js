(function(D,F){typeof exports==="object"&&typeof module!=="undefined"?module.exports=F(require("stream")):typeof define==="function"&&define.amd?define(["stream"],F):(D=typeof globalThis!=="undefined"?globalThis:D||self,D.JMuxer=F(D.stream))})(this,function(D){function F(c){for(var a=0,d=0;d<32;d++)a<<=1,a|=c&1,c>>>=1;return a>>>0}function N(c,a){(null==a||a>c.length)&&(a=c.length);for(var d=0,b=Array(a);d<a;d++)b[d]=c[d];return b}function O(c){if(void 0===c)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
return c}function u(c,a){if(!(c instanceof a))throw new TypeError("Cannot call a class as a function");}function V(c,a){for(var d=0;d<a.length;d++){var b=a[d];b.enumerable=b.enumerable||!1;b.configurable=!0;"value"in b&&(b.writable=!0);Object.defineProperty(c,W(b.key),b)}}function v(c,a,d){return a&&V(c.prototype,a),d&&V(c,d),Object.defineProperty(c,"prototype",{writable:!1}),c}function y(c,a){var d="undefined"!=typeof Symbol&&c[Symbol.iterator]||c["@@iterator"];if(!d){if(Array.isArray(c)||(d=P(c))||
a&&c&&"number"==typeof c.length){d&&(c=d);var b=0;a=function(){};return{s:a,n:function(){return b>=c.length?{done:!0}:{done:!1,value:c[b++]}},e:function(h){throw h;},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var e,g=!0,f=!1;return{s:function(){d=d.call(c)},n:function(){var h=d.next();return g=h.done,h},e:function(h){f=!0;e=h},f:function(){try{g||null==d.return||d.return()}finally{if(f)throw e;
}}}}function A(c){var a=X();return function(){var d=H(c);if(a){var b=H(this).constructor;d=Reflect.construct(d,arguments,b)}else d=d.apply(this,arguments);if(!d||"object"!=typeof d&&"function"!=typeof d){if(void 0!==d)throw new TypeError("Derived constructors may only return object or undefined");d=O(this)}return d}}function r(c,a,d){return(a=W(a))in c?Object.defineProperty(c,a,{value:d,enumerable:!0,configurable:!0,writable:!0}):c[a]=d,c}function H(c){return H=Object.setPrototypeOf?Object.getPrototypeOf.bind():
function(a){return a.__proto__||Object.getPrototypeOf(a)},H(c)}function B(c,a){if("function"!=typeof a&&null!==a)throw new TypeError("Super expression must either be null or a function");c.prototype=Object.create(a&&a.prototype,{constructor:{value:c,writable:!0,configurable:!0}});Object.defineProperty(c,"prototype",{writable:!1});a&&Q(c,a)}function X(){try{var c=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(a){}return(X=function(){return!!c})()}function Q(c,a){return Q=
Object.setPrototypeOf?Object.setPrototypeOf.bind():function(d,b){return d.__proto__=b,d},Q(c,a)}function Y(c,a){var d=Array.isArray(c)?c:void 0;if(!d)a:{var b=null==c?null:"undefined"!=typeof Symbol&&c[Symbol.iterator]||c["@@iterator"];if(null!=b){var e,g,f,h=[],k=!0,n=!1;try{if(g=(b=b.call(c)).next,0===a){if(Object(b)!==b){d=void 0;break a}k=!1}else for(;!(k=(e=g.call(b)).done)&&(h.push(e.value),h.length!==a);k=!0);}catch(l){n=!0;var m=l}finally{try{if(!k&&null!=b.return&&(f=b.return(),Object(f)!==
f)){d=void 0;break a}}finally{if(n)throw m;}}d=h}else d=void 0}if(!(c=d||P(c,a)))throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");return c}function I(c){var a=Array.isArray(c)?N(c):void 0;a||(a="undefined"!=typeof Symbol&&null!=c[Symbol.iterator]||null!=c["@@iterator"]?Array.from(c):void 0);if(!(c=a||P(c)))throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
return c}function W(c){a:if("object"==typeof c&&c){var a=c[Symbol.toPrimitive];if(void 0!==a){c=a.call(c,"string");if("object"!=typeof c)break a;throw new TypeError("@@toPrimitive must return a primitive value.");}c=String(c)}return"symbol"==typeof c?c:c+""}function R(c){"@babel/helpers - typeof";return R="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},
R(c)}function P(c,a){if(c){if("string"==typeof c)return N(c,a);var d={}.toString.call(c).slice(8,-1);return"Object"===d&&c.constructor&&(d=c.constructor.name),"Map"===d||"Set"===d?Array.from(c):"Arguments"===d||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d)?N(c,a):void 0}}function ba(c,a){S=c;T=a}function q(c){if(S){for(var a=arguments.length,d=Array(a>1?a-1:0),b=1;b<a;b++)d[b-1]=arguments[b];S.apply(void 0,[c].concat(d))}}function x(c){if(T){for(var a=arguments.length,d=Array(a>1?a-1:0),b=1;b<
a;b++)d[b-1]=arguments[b];T.apply(void 0,[c].concat(d))}}function J(c,a){var d=new Uint8Array((c.byteLength|0)+(a.byteLength|0));d.set(c,0);d.set(a,c.byteLength|0);return d}var S,T,K=function(){function c(a){u(this,c);this.listener={};this.type=a|0}v(c,[{key:"on",value:function(a,d){this.listener[a]||(this.listener[a]=[]);this.listener[a].push(d);return!0}},{key:"off",value:function(a,d){return this.listener[a]?(d=this.listener[a].indexOf(d),d>-1&&this.listener[a].splice(d,1),!0):!1}},{key:"offAll",
value:function(){this.listener={}}},{key:"dispatch",value:function(a){for(var d=arguments.length,b=Array(d>1?d-1:0),e=1;e<d;e++)b[e-1]=arguments[e];return this.listener[a]?(this.listener[a].map(function(g){g.apply(null,b)}),!0):!1}}]);return c}(),L=function(){function c(){u(this,c)}v(c,null,[{key:"init",value:function(){c.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],hev1:[],hvcC:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],
stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};for(var a in c.types)c.types.hasOwnProperty(a)&&(c.types[a]=[a.charCodeAt(0),a.charCodeAt(1),a.charCodeAt(2),a.charCodeAt(3)]);a=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]);var d=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);c.HDLR_TYPES=
{video:a,audio:d};a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);d=new Uint8Array([0,0,0,0,0,0,0,0]);c.STTS=c.STSC=c.STCO=d;c.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);c.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]);c.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]);c.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);d=new Uint8Array([105,115,111,109]);var b=new Uint8Array([97,118,99,49]),e=new Uint8Array([0,0,0,1]);c.FTYP=c.box(c.types.ftyp,d,e,d,b);c.DINF=c.box(c.types.dinf,c.box(c.types.dref,
a))}},{key:"box",value:function(a){for(var d=arguments.length,b=Array(d>1?d-1:0),e=1;e<d;e++)b[e-1]=arguments[e];d=8;for(var g=e=b.length,f;e--;)d+=b[e].byteLength;f=new Uint8Array(d);f[0]=d>>24&255;f[1]=d>>16&255;f[2]=d>>8&255;f[3]=d&255;f.set(a,4);e=0;for(d=8;e<g;++e)f.set(b[e],d),d+=b[e].byteLength;return f}},{key:"hdlr",value:function(a){return c.box(c.types.hdlr,c.HDLR_TYPES[a])}},{key:"mdat",value:function(a){return c.box(c.types.mdat,a)}},{key:"mdhd",value:function(a,d){return c.box(c.types.mdhd,
new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,a>>24&255,a>>16&255,a>>8&255,a&255,d>>>24&255,d>>>16&255,d>>>8&255,d&255,85,196,0,0]))}},{key:"mdia",value:function(a){return c.box(c.types.mdia,c.mdhd(a.timescale,a.duration),c.hdlr(a.type),c.minf(a))}},{key:"mfhd",value:function(a){return c.box(c.types.mfhd,new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,a&255]))}},{key:"minf",value:function(a){return a.type==="audio"?c.box(c.types.minf,c.box(c.types.smhd,c.SMHD),c.DINF,c.stbl(a)):c.box(c.types.minf,c.box(c.types.vmhd,
c.VMHD),c.DINF,c.stbl(a))}},{key:"moof",value:function(a,d,b){return c.box(c.types.moof,c.mfhd(a),c.traf(b,d))}},{key:"moov",value:function(a,d,b){for(var e=a.length,g=[];e--;)g[e]=c.trak(a[e]);return c.box.apply(null,[c.types.moov,c.mvhd(b,d)].concat(g).concat(c.mvex(a)))}},{key:"mvex",value:function(a){for(var d=a.length,b=[];d--;)b[d]=c.trex(a[d]);return c.box.apply(null,[c.types.mvex].concat(b))}},{key:"mvhd",value:function(a,d){a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,a>>24&255,a>>16&255,a>>
8&255,a&255,d>>>24&255,d>>>16&255,d>>>8&255,d&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return c.box(c.types.mvhd,a)}},{key:"sdtp",value:function(a){a=a.samples||[];var d=new Uint8Array(4+a.length),b;for(b=0;b<a.length;b++){var e=a[b].flags;d[b+4]=e.dependsOn<<4|e.isDependedOn<<2|e.hasRedundancy}return c.box(c.types.sdtp,d)}},{key:"stbl",value:function(a){return c.box(c.types.stbl,
c.stsd(a),c.box(c.types.stts,c.STTS),c.box(c.types.stsc,c.STSC),c.box(c.types.stsz,c.STSZ),c.box(c.types.stco,c.STCO))}},{key:"avc1",value:function(a){var d=[],b=[],e;for(e=0;e<a.sps.length;e++){var g=a.sps[e];var f=g.byteLength;d.push(f>>>8&255);d.push(f&255);d=d.concat(Array.prototype.slice.call(g))}for(e=0;e<a.pps.length;e++)g=a.pps[e],f=g.byteLength,b.push(f>>>8&255),b.push(f&255),b=b.concat(Array.prototype.slice.call(g));d=c.box(c.types.avcC,new Uint8Array([1,d[3],d[4],d[5],255,224|a.sps.length].concat(d).concat([a.pps.length]).concat(b)));
b=a.width;a=a.height;return c.box(c.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,b>>8&255,b&255,a>>8&255,a&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,108,112,114,111,46,114,117,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),d,c.box(c.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}},{key:"hev1",value:function(a){for(var d=[],b=[],e=[],g,f,h=0;h<(((k=a.vps)===null||k===void 0?void 0:k.length)||0);h++){var k;g=a.vps[h];f=g.byteLength;
d.push(f>>>8&255,f&255);d=d.concat(Array.prototype.slice.call(g))}for(h=0;h<(((n=a.sps)===null||n===void 0?void 0:n.length)||0);h++){var n;g=a.sps[h];f=g.byteLength;b.push(f>>>8&255,f&255);b=b.concat(Array.prototype.slice.call(g))}for(n=0;n<(((m=a.pps)===null||m===void 0?void 0:m.length)||0);n++){var m;g=a.pps[n];f=g.byteLength;e.push(f>>>8&255,f&255);e=e.concat(Array.prototype.slice.call(g))}g=a.hvcC;f=g.profile_compatibility_flags;m=g.level_idc;n=g.chroma_format_idc;d=c.box(c.types.hvcC,new Uint8Array([1,
g.profile_space<<6|g.tier_flag<<5|g.profile_idc,f>>24&255,f>>16&255,f>>8&255,f&255].concat(I(g.constraint_indicator_flags),[m,240,0,252,252|n,248,248,0,0,3,3,32,0,1],I(d),[33,0,1],I(b),[34,0,1],I(e))));b=a.width;a=a.height;return c.box(c.types.hev1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,b>>8&255,b&255,a>>8&255,a&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,108,112,114,111,46,114,117,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),d,c.box(c.types.btrt,new Uint8Array([0,
28,156,128,0,45,198,192,0,45,198,192])))}},{key:"esds",value:function(a){var d=a.config.byteLength,b=new Uint8Array(26+d+3);b.set([0,0,0,0,3,23+d,0,1,0,4,15+d,64,21,0,0,0,0,0,0,0,0,0,0,0,5,d]);b.set(a.config,26);b.set([6,1,2],26+d);return b}},{key:"mp4a",value:function(a){var d=a.audiosamplerate;return c.box(c.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,a.channelCount,0,16,0,0,0,0,d>>8&255,d&255,0,0]),c.box(c.types.esds,c.esds(a)))}},{key:"stsd",value:function(a){return a.type===
"audio"?c.box(c.types.stsd,c.STSD,c.mp4a(a)):a.codec.startsWith("hvc1")?c.box(c.types.stsd,c.STSD,c.hev1(a)):c.box(c.types.stsd,c.STSD,c.avc1(a))}},{key:"tkhd",value:function(a){var d=a.id,b=a.duration,e=a.width,g=a.height;a=a.volume;return c.box(c.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,d>>24&255,d>>16&255,d>>8&255,d&255,0,0,0,0,b>>>24&255,b>>>16&255,b>>>8&255,b&255,0,0,0,0,0,0,0,0,0,0,0,0,a>>0&255,a%1*10>>0&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,
0,0,e>>8&255,e&255,0,0,g>>8&255,g&255,0,0]))}},{key:"traf",value:function(a,d){var b=c.sdtp(a),e=a.id;return c.box(c.types.traf,c.box(c.types.tfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255])),c.box(c.types.tfdt,new Uint8Array([0,0,0,0,d>>24,d>>16&255,d>>8&255,d&255])),c.trun(a,b.length+16+16+8+16+8+8),b)}},{key:"trak",value:function(a){a.duration=a.duration||4294967295;return c.box(c.types.trak,c.tkhd(a),c.mdia(a))}},{key:"trex",value:function(a){a=a.id;return c.box(c.types.trex,new Uint8Array([0,
0,0,0,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function(a,d){a=a.samples||[];var b=a.length,e=12+16*b,g=new Uint8Array(e);d+=8+e;g.set([0,0,15,1,b>>>24&255,b>>>16&255,b>>>8&255,b&255,d>>>24&255,d>>>16&255,d>>>8&255,d&255],0);for(d=0;d<b;d++){var f=a[d];e=f.duration;var h=f.size;var k=f.flags;f=f.cts;g.set([e>>>24&255,e>>>16&255,e>>>8&255,e&255,h>>>24&255,h>>>16&255,h>>>8&255,h&255,k.isLeading<<2|k.dependsOn,k.isDependedOn<<6|k.hasRedundancy<<4|k.paddingValue<<
1|k.isNonSync,k.degradPrio&61440,k.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*d)}return c.box(c.types.trun,g)}},{key:"initSegment",value:function(a,d,b){c.types||c.init();a=c.moov(a,d,b);d=new Uint8Array(c.FTYP.byteLength+a.byteLength);d.set(c.FTYP);d.set(a,c.FTYP.byteLength);return d}}]);return c}(),ca=function(){function c(){u(this,c)}v(c,null,[{key:"samplingRateMap",get:function(){return[96E3,88200,64E3,48E3,44100,32E3,24E3,22050,16E3,12E3,11025,8E3,7350]}},{key:"getHeaderLength",
value:function(a){return a[1]&1?7:9}},{key:"getFrameLength",value:function(a){return(a[3]&3)<<11|a[4]<<3|(a[5]&224)>>>5}},{key:"isAACPattern",value:function(a){return a[0]===255&&(a[1]&240)===240&&(a[1]&6)===0}},{key:"extractAAC",value:function(a){var d=0,b=a.byteLength,e=[];if(!c.isAACPattern(a))return x("Invalid ADTS audio format"),{valid:!1};var g=c.getHeaderLength(a);for(var f=a.subarray(0,g);d<b;){var h=c.getFrameLength(a);e.push(a.subarray(g,h));a=a.slice(h);d+=h}return{valid:!0,header:f,slices:e}}}]);
return c}(),da=1,E=function(c){function a(){u(this,a);return d.apply(this,arguments)}B(a,c);var d=A(a);v(a,[{key:"flush",value:function(){this.mp4track.len=0;this.mp4track.samples=[]}},{key:"isReady",value:function(){return this.readyToDecode&&this.samples.length?!0:null}}],[{key:"getTrackID",value:function(){return da++}}]);return a}(K),ea=function(c){function a(b,e,g){u(this,a);var f=d.call(this,"AACRemuxer");f.frameDuration=g;f.readyToDecode=!1;f.header=null;f.nextDts=0;f.dts=0;f.mp4track={id:E.getTrackID(),
type:"audio",channelCount:0,len:0,fragmented:!0,timescale:b,duration:e,samples:[],config:"",codec:""};f.samples=[];return f}B(a,c);var d=A(a);v(a,[{key:"resetTrack",value:function(){this.readyToDecode=!1;this.header=null;this.mp4track.codec="";this.mp4track.channelCount="";this.mp4track.config="";this.mp4track.timescale=this.timescale;this.dts=this.nextDts=0}},{key:"feed",value:function(b,e){var g=ca.extractAAC(b),f=g.valid,h=g.header;g=g.slices;this.header||(this.header=h);if(f&&g.length>0)return this.remux(this.getAudioFrames(g,
e)),!0;x("Failed to extract audio data from:",b);this.dispatch("outOfData");return!1}},{key:"getAudioFrames",value:function(b,e){var g=[],f=0,h=0;b=y(b);var k;try{for(b.s();!(k=b.n()).done;)g.push({units:k.value})}catch(n){b.e(n)}finally{b.f()}f=e?e/g.length|0:this.frameDuration;h=e?e-f*g.length:0;g.map(function(n){n.duration=f;h>0&&(n.duration++,h--)});return g}},{key:"remux",value:function(b){if(b.length>0)for(var e=0;e<b.length;e++){var g=b[e],f=g.units,h=f.byteLength;this.samples.push({units:f,
size:h,duration:g.duration});this.mp4track.len+=h;this.readyToDecode||this.setAACConfig()}}},{key:"getPayload",value:function(){if(!this.isReady())return null;var b=new Uint8Array(this.mp4track.len),e=0,g=this.mp4track.samples;for(this.dts=this.nextDts;this.samples.length;){var f=this.samples.shift();f.units;var h=f.duration;h<=0?(q("remuxer: invalid sample duration at DTS: ".concat(this.nextDts," :").concat(h)),this.mp4track.len-=f.size):(this.nextDts+=h,h={size:f.size,duration:h,cts:0,flags:{isLeading:0,
isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},b.set(f.units,e),e+=f.size,g.push(h))}return g.length?new Uint8Array(b.buffer,0,this.mp4track.len):null}},{key:"setAACConfig",value:function(){var b=new Uint8Array(2);if(this.header){var e=((this.header[2]&192)>>>6)+1;var g=(this.header[2]&60)>>>2;var f=(this.header[2]&1)<<2;f|=(this.header[3]&192)>>>6;b[0]=e<<3;b[0]|=(g&14)>>1;b[1]|=(g&1)<<7;b[1]|=f<<3;this.mp4track.codec="mp4a.40."+e;this.mp4track.channelCount=f;this.mp4track.config=b;this.readyToDecode=
!0}}}]);return a}(E),M=function(){function c(a){u(this,c);this.data=a;this.index=0;this.bitLength=a.byteLength*8}v(c,[{key:"setData",value:function(a){this.data=a;this.index=0;this.bitLength=a.byteLength*8}},{key:"bitsAvailable",get:function(){return this.bitLength-this.index}},{key:"skipBits",value:function(a){if(this.bitsAvailable<a)return!1;this.index+=a}},{key:"readBits",value:function(a){return this.getBits(a,this.index,arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0)}},{key:"getBits",
value:function(a,d){var b=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(this.bitsAvailable<a)return 0;var e=d%8,g=this.data[d/8|0]&255>>>e;e=8-e;if(e>=a)return b&&(this.index+=a),g>>e-a;b&&(this.index+=e);var f=a-e;return g<<f|this.getBits(f,d+e,b)}},{key:"skipLZ",value:function(){var a;for(a=0;a<this.bitLength-this.index;++a)if(this.getBits(1,this.index+a,!1)!==0){this.index+=a;break}return a}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"skipEG",value:function(){this.skipBits(1+
this.skipLZ())}},{key:"readUEG",value:function(){var a=this.skipLZ();return this.readBits(a+1)-1}},{key:"readEG",value:function(){var a=this.readUEG();return 1&a?1+a>>>1:-1*(a>>>1)}},{key:"readBoolean",value:function(){return this.readBits(1)===1}},{key:"readUByte",value:function(){return this.readBits((arguments.length>0&&arguments[0]!==void 0?arguments[0]:1)*8)}},{key:"readUShort",value:function(){return this.readBits(16)}},{key:"readUInt",value:function(){return this.readBits(32)}}]);return c}(),
Z=function(){function c(){u(this,c)}v(c,null,[{key:"extractNALu",value:function(a){for(var d=0,b=a.byteLength,e=[],g=0,f=0;d<b;){var h=a[d++];h===0?f++:(h===1&&f>=2&&(f+=1,g!==d-f&&e.push(a.subarray(g,d-f)),g=d),f=0)}g<b&&e.push(a.subarray(g,b));return[e,null]}},{key:"skipScalingList",value:function(a,d){for(var b=8,e=8,g=0;g<d;g++)e!==0&&(e=a.readEG(),e=(b+e+256)%256),b=e===0?b:e}},{key:"readSPS",value:function(a){var d=new M(a),b=0,e=0,g=0,f=0,h=1,k,n=0;d.readUByte();var m=[];a=a.byteLength;for(k=
1;k<a;k++)k+2<a&&d.readBits(24,!1)===3?(m.push(d.readBits(8)),m.push(d.readBits(8)),k+=2,d.readBits(8)):m.push(d.readBits(8));d.setData(new Uint8Array(m));m=d.readUByte();d.readBits(5);d.skipBits(3);d.readUByte();d.skipUEG();if(m===100||m===110||m===122||m===244||m===44||m===83||m===86||m===118||m===128)if(m=d.readUEG(),m===3&&d.skipBits(1),d.skipUEG(),d.skipUEG(),d.skipBits(1),d.readBoolean())for(m=m!==3?8:12,a=0;a<m;++a)d.readBoolean()&&(a<6?c.skipScalingList(d,16):c.skipScalingList(d,64));d.skipUEG();
m=d.readUEG();if(m===0)d.readUEG();else if(m===1)for(d.skipBits(1),d.skipEG(),d.skipEG(),m=d.readUEG(),a=0;a<m;++a)d.skipEG();d.skipUEG();d.skipBits(1);m=d.readUEG();a=d.readUEG();k=d.readBits(1);k===0&&d.skipBits(1);d.skipBits(1);d.readBoolean()&&(b=d.readUEG(),e=d.readUEG(),g=d.readUEG(),f=d.readUEG());if(d.readBoolean()){if(d.readBoolean()){switch(d.readUByte()){case 1:var l=[1,1];break;case 2:l=[12,11];break;case 3:l=[10,11];break;case 4:l=[16,11];break;case 5:l=[40,33];break;case 6:l=[24,11];
break;case 7:l=[20,11];break;case 8:l=[32,11];break;case 9:l=[80,33];break;case 10:l=[18,11];break;case 11:l=[15,11];break;case 12:l=[64,33];break;case 13:l=[160,99];break;case 14:l=[4,3];break;case 15:l=[3,2];break;case 16:l=[2,1];break;case 255:l=[d.readUByte()<<8|d.readUByte(),d.readUByte()<<8|d.readUByte()]}l&&l[0]>0&&l[1]>0&&(h=l[0]/l[1])}d.readBoolean()&&d.skipBits(1);d.readBoolean()&&(d.skipBits(4),d.readBoolean()&&d.skipBits(24));d.readBoolean()&&(d.skipUEG(),d.skipUEG());if(d.readBoolean()){l=
d.readUInt();var p=d.readUInt();d.readBoolean()&&(n=p/(2*l))}}return{fps:n>0?n:void 0,width:Math.ceil(((m+1)*16-b*2-e*2)*h),height:(2-k)*(a+1)*16-(k?2:4)*(g+f)}}}]);return c}(),G=function(){function c(a){u(this,c);this.payload=a;this.nri=(this.payload[0]&96)>>5;this.nalUnitType=this.payload[0]&31;this._sliceType=null;this._isFirstSlice=!1}v(c,[{key:"toString",value:function(){return"".concat(c.TYPES[this.type()]||"UNKNOWN",": NRI: ").concat(this.getNri())}},{key:"getNri",value:function(){return this.nri}},
{key:"type",value:function(){return this.nalUnitType}},{key:"isKeyframe",get:function(){return this.nalUnitType===c.IDR}},{key:"isVCL",get:function(){return this.nalUnitType==c.IDR||this.nalUnitType==c.NDR}},{key:"parseHeader",value:function(){var a=new M(this.getPayload());a.readUByte();this._isFirstSlice=a.readUEG()===0;this._sliceType=a.readUEG()}},{key:"isFirstSlice",get:function(){this._isFirstSlice||this.parseHeader();return this._isFirstSlice}},{key:"sliceType",get:function(){this._sliceType||
this.parseHeader();return this._sliceType}},{key:"getPayload",value:function(){return this.payload}},{key:"getPayloadSize",value:function(){return this.payload.byteLength}},{key:"getSize",value:function(){return 4+this.getPayloadSize()}},{key:"getData",value:function(){var a=new Uint8Array(this.getSize());(new DataView(a.buffer)).setUint32(0,this.getSize()-4);a.set(this.getPayload(),4);return a}}],[{key:"NDR",get:function(){return 1}},{key:"IDR",get:function(){return 5}},{key:"SEI",get:function(){return 6}},
{key:"SPS",get:function(){return 7}},{key:"PPS",get:function(){return 8}},{key:"AUD",get:function(){return 9}},{key:"TYPES",get:function(){var a;return a={},r(a,c.IDR,"IDR"),r(a,c.SEI,"SEI"),r(a,c.SPS,"SPS"),r(a,c.PPS,"PPS"),r(a,c.NDR,"NDR"),r(a,c.AUD,"AUD"),a}}]);return c}(),fa=function(c){function a(b,e,g){u(this,a);var f=d.call(this,"H264Remuxer");f.frameDuration=g;f.readyToDecode=!1;f.nextDts=0;f.dts=0;f.mp4track={id:E.getTrackID(),type:"video",len:0,fragmented:!0,sps:"",pps:"",fps:30,width:0,
height:0,timescale:b,duration:e,samples:[]};f.samples=[];f.remainingData=new Uint8Array;f.kfCounter=0;f.pendingUnits={};return f}B(a,c);var d=A(a);v(a,[{key:"resetTrack",value:function(){this.readyToDecode=!1;this.mp4track.sps="";this.mp4track.pps="";this.dts=this.nextDts=0;this.remainingData=new Uint8Array;this.kfCounter=0;this.pendingUnits={}}},{key:"feed",value:function(b,e,g){b=J(this.remainingData,b);b=Z.extractNALu(b);var f=Y(b,2);b=f[0];this.remainingData=(f=f[1])||new Uint8Array;if(b.length>
0)return this.remux(this.getVideoFrames(b,e,g)),!0;x("Failed to extract any NAL units from video data:",f);this.dispatch("outOfData");return!1}},{key:"getVideoFrames",value:function(b,e,g){var f=this,h=[],k=[],n=0,m=0,l=!1,p=!1;this.pendingUnits.units&&(h=this.pendingUnits.units,p=this.pendingUnits.vcl,l=this.pendingUnits.keyFrame,this.pendingUnits={});b=y(b);var z;try{for(b.s();!(z=b.n()).done;){var w=new G(z.value);h.length&&p&&(w.isFirstSlice||!w.isVCL)&&(k.push({units:h,keyFrame:l}),h=[],p=l=
!1);h.push(w);l=l||w.isKeyframe;p=p||w.isVCL}}catch(t){b.e(t)}finally{b.f()}h.length&&(e?p?k.push({units:h,keyFrame:l}):(l=k.length-1,l>=0&&(k[l].units=k[l].units.concat(h))):this.pendingUnits={units:h,keyFrame:l,vcl:p});n=e?e/k.length|0:this.frameDuration;m=e?e-n*k.length:0;k.map(function(t){t.duration=n;t.compositionTimeOffset=g;m>0&&(t.duration++,m--);f.kfCounter++;t.keyFrame&&f.dispatch("keyframePosition",f.kfCounter*n/1E3)});q("jmuxer: No. of H264 frames of the last chunk: ".concat(k.length));
return k}},{key:"remux",value:function(b){b=y(b);var e;try{for(b.s();!(e=b.n()).done;){var g=e.value,f=[],h=0,k=y(g.units),n;try{for(k.s();!(n=k.n()).done;){var m=n.value;this.parseNAL(m)&&(f.push(m),h+=m.getSize())}}catch(l){k.e(l)}finally{k.f()}f.length>0&&this.readyToDecode&&(this.mp4track.len+=h,this.samples.push({units:f,size:h,keyFrame:g.keyFrame,duration:g.duration,compositionTimeOffset:g.compositionTimeOffset}))}}catch(l){b.e(l)}finally{b.f()}}},{key:"getPayload",value:function(){if(!this.isReady())return null;
var b=new Uint8Array(this.mp4track.len),e=0,g=this.mp4track.samples;for(this.dts=this.nextDts;this.samples.length;){var f=this.samples.shift(),h=f.units;var k=f.duration;if(k<=0)q("remuxer: invalid sample duration at DTS: ".concat(this.nextDts," :").concat(k)),this.mp4track.len-=f.size;else{this.nextDts+=k;k={size:f.size,duration:k,cts:f.compositionTimeOffset||0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,isNonSync:f.keyFrame?0:1,dependsOn:f.keyFrame?2:1}};h=y(h);var n;try{for(h.s();!(n=
h.n()).done;){var m=n.value;b.set(m.getData(),e);e+=m.getSize()}}catch(l){h.e(l)}finally{h.f()}g.push(k)}}return g.length?new Uint8Array(b.buffer,0,this.mp4track.len):null}},{key:"parseSPS",value:function(b){var e=Z.readSPS(new Uint8Array(b));this.mp4track.fps=e.fps||this.mp4track.fps;this.mp4track.width=e.width;this.mp4track.height=e.height;this.mp4track.sps=[new Uint8Array(b)];this.mp4track.codec="avc1.";b=new DataView(b.buffer,b.byteOffset+1,4);for(e=0;e<3;++e){var g=b.getUint8(e).toString(16);
g.length<2&&(g="0"+g);this.mp4track.codec+=g}}},{key:"parsePPS",value:function(b){this.mp4track.pps=[new Uint8Array(b)]}},{key:"parseNAL",value:function(b){if(!b)return!1;if(b.isVCL)return!0;var e=!1;switch(b.type()){case G.PPS:this.mp4track.pps||this.parsePPS(b.getPayload());e=!0;break;case G.SPS:this.mp4track.sps||this.parseSPS(b.getPayload());e=!0;break;case G.AUD:q("AUD - ignoing");break;case G.SEI:q("SEI - ignoing")}!this.readyToDecode&&this.mp4track.pps&&this.mp4track.sps&&(this.readyToDecode=
!0);return e}}]);return a}(E),U=function(){function c(){u(this,c)}v(c,null,[{key:"extractNALu",value:function(a){for(var d=0,b=a.byteLength,e=[],g=0,f=0;d<b;){var h=a[d++];h===0?f++:(h===1&&f>=2&&(f+=1,g!==d-f&&e.push(a.subarray(g,d-f)),g=d),f=0)}g<b&&e.push(a.subarray(g,b));return[e,null]}},{key:"removeEmulationPreventionBytes",value:function(a){for(var d=[],b=0,e=0;e<a.length;e++){var g=a[e];b===2&&g===3?b=0:(d.push(g),g===0?b++:b=0)}return new Uint8Array(d)}},{key:"readSPS",value:function(a){a=
new M(a);a.readUByte();a.readUByte();a.readBits(4);a.readBits(3);a.readBits(1);for(var d=a.readBits(2),b=a.readBits(1),e=a.readBits(5),g=a.readUInt(),f=new Uint8Array(6),h=0;h<6;h++)f[h]=a.readUByte();h=a.readUByte();a.readUEG();var k=a.readUEG();k===3&&a.readBits(1);var n=a.readUEG(),m=a.readUEG(),l=0,p=0,z=0,w=0;a.readBoolean()&&(l=a.readUEG(),p=a.readUEG(),z=a.readUEG(),w=a.readUEG());var t=null;if(a.readBoolean()&&(a.readBoolean()&&a.readUByte()===255&&(a.readUShort(),a.readUShort()),a.readBoolean()&&
a.readBoolean(),a.readBoolean()&&(a.readBits(3),a.readBoolean(),a.readBoolean()&&(a.readUByte(),a.readUByte(),a.readUByte())),a.readBoolean()&&(a.readUEG(),a.readUEG()),a.readBoolean(),a.readBoolean(),a.readBoolean(),a.readBoolean())){var aa=a.readUInt(),ha=a.readUInt();a.readBoolean();aa&&(t=ha/(2*aa))}return{width:n-(k===1||k===2?2:1)*(p+l),height:m-(k===1?2:1)*(z+w),profile_space:d,tier_flag:b,profile_idc:e,profile_compatibility_flags:g,constraint_indicator_flags:f,level_idc:h,chroma_format_idc:k,
fps:t}}}]);return c}(),C=function(){function c(a){u(this,c);this.payload=a;this.nalUnitType=(a[0]&126)>>1;this.nuhLayerId=(a[0]&1)<<5|(a[1]&248)>>3;this.nuhTemporalIdPlus1=a[1]&7;this._sliceType=this._isFirstSlice=null}v(c,[{key:"toString",value:function(){return"".concat(c.TYPES[this.type()]||"UNKNOWN ("+this.type()+")",": Layer: ").concat(this.nuhLayerId,", Temporal Id: ").concat(this.nuhTemporalIdPlus1)}},{key:"type",value:function(){return this.nalUnitType}},{key:"isKeyframe",get:function(){return[c.IDR_W_RADL,
c.IDR_N_LP,c.CRA].includes(this.nalUnitType)}},{key:"isVCL",get:function(){return this.nalUnitType<=31}},{key:"parseHeader",value:function(){var a=new M(this.getPayload());a.readUByte();a.readUByte();this._isFirstSlice=a.readBoolean();this.isKeyframe&&a.readBits(1);a.readUEG();this._sliceType=a.readUEG()}},{key:"isFirstSlice",get:function(){this._isFirstSlice||this.parseHeader();return this._isFirstSlice}},{key:"sliceType",get:function(){this._sliceType||this.parseHeader();return this._sliceType}},
{key:"getPayload",value:function(){return this.payload}},{key:"getPayloadSize",value:function(){return this.payload.byteLength}},{key:"getSize",value:function(){return 4+this.getPayloadSize()}},{key:"getData",value:function(){var a=new Uint8Array(this.getSize());(new DataView(a.buffer)).setUint32(0,this.getSize()-4);a.set(this.getPayload(),4);return a}}],[{key:"TRAIL_N",get:function(){return 0}},{key:"TRAIL_R",get:function(){return 1}},{key:"IDR_W_RADL",get:function(){return 19}},{key:"IDR_N_LP",
get:function(){return 20}},{key:"CRA",get:function(){return 21}},{key:"VPS",get:function(){return 32}},{key:"SPS",get:function(){return 33}},{key:"PPS",get:function(){return 34}},{key:"AUD",get:function(){return 35}},{key:"SEI",get:function(){return 39}},{key:"SEI2",get:function(){return 40}},{key:"TYPES",get:function(){var a;return a={},r(a,c.TRAIL_N,"TRAIL_N"),r(a,c.TRAIL_R,"TRAIL_R"),r(a,c.IDR_W_RADL,"IDR"),r(a,c.IDR_N_LP,"IDR2"),r(a,c.CRA,"CRA"),r(a,c.VPS,"VPS"),r(a,c.SPS,"SPS"),r(a,c.PPS,"PPS"),
r(a,c.AUD,"AUD"),r(a,c.SEI,"SEI"),r(a,c.SEI2,"SEI2"),a}}]);return c}(),ia=function(c){function a(b,e,g){u(this,a);var f=d.call(this,"H264Remuxer");f.frameDuration=g;f.readyToDecode=!1;f.nextDts=0;f.dts=0;f.mp4track={id:E.getTrackID(),type:"video",len:0,fragmented:!0,vps:"",sps:"",pps:"",hvcC:{},fps:30,width:0,height:0,timescale:b,duration:e,samples:[]};f.samples=[];f.remainingData=new Uint8Array;f.kfCounter=0;f.pendingUnits={};return f}B(a,c);var d=A(a);v(a,[{key:"resetTrack",value:function(){this.readyToDecode=
!1;this.mp4track.vps="";this.mp4track.sps="";this.mp4track.pps="";this.mp4track.hvcC={};this.dts=this.nextDts=0;this.remainingData=new Uint8Array;this.kfCounter=0;this.pendingUnits={}}},{key:"feed",value:function(b,e,g){b=J(this.remainingData,b);b=U.extractNALu(b);var f=Y(b,2);b=f[0];this.remainingData=(f=f[1])||new Uint8Array;if(b.length>0)return this.remux(this.getVideoFrames(b,e,g)),!0;x("Failed to extract any NAL units from video data:",f);this.dispatch("outOfData");return!1}},{key:"getVideoFrames",
value:function(b,e,g){var f=this,h=[],k=[],n=0,m=0,l=!1,p=!1;this.pendingUnits.units&&(h=this.pendingUnits.units,p=this.pendingUnits.vcl,l=this.pendingUnits.keyFrame,this.pendingUnits={});b=y(b);var z;try{for(b.s();!(z=b.n()).done;){var w=new C(z.value);h.length&&p&&(w.isFirstSlice||!w.isVCL)&&(k.push({units:h,keyFrame:l}),h=[],p=l=!1);h.push(w);l=l||w.isKeyframe;p=p||w.isVCL}}catch(t){b.e(t)}finally{b.f()}h.length&&(e?p?k.push({units:h,keyFrame:l}):(l=k.length-1,l>=0&&(k[l].units=k[l].units.concat(h))):
this.pendingUnits={units:h,keyFrame:l,vcl:p});n=e?e/k.length|0:this.frameDuration;m=e?e-n*k.length:0;k.map(function(t){t.duration=n;t.compositionTimeOffset=g;m>0&&(t.duration++,m--);f.kfCounter++;t.keyFrame&&f.dispatch("keyframePosition",f.kfCounter*n/1E3)});q("jmuxer: No. of H265 frames of the last chunk: ".concat(k.length));return k}},{key:"remux",value:function(b){b=y(b);var e;try{for(b.s();!(e=b.n()).done;){var g=e.value,f=[],h=0,k=y(g.units),n;try{for(k.s();!(n=k.n()).done;){var m=n.value;this.parseNAL(m)&&
(f.push(m),h+=m.getSize())}}catch(l){k.e(l)}finally{k.f()}f.length>0&&this.readyToDecode&&(this.mp4track.len+=h,this.samples.push({units:f,size:h,keyFrame:g.keyFrame,duration:g.duration,compositionTimeOffset:g.compositionTimeOffset}))}}catch(l){b.e(l)}finally{b.f()}}},{key:"getPayload",value:function(){if(!this.isReady())return null;var b=new Uint8Array(this.mp4track.len),e=0,g=this.mp4track.samples;for(this.dts=this.nextDts;this.samples.length;){var f=this.samples.shift(),h=f.units;var k=f.duration;
if(k<=0)q("remuxer: invalid sample duration at DTS: ".concat(this.nextDts," :").concat(k)),this.mp4track.len-=f.size;else{this.nextDts+=k;k={size:f.size,duration:k,cts:f.compositionTimeOffset||0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,isNonSync:f.keyFrame?0:1,dependsOn:f.keyFrame?2:1}};h=y(h);var n;try{for(h.s();!(n=h.n()).done;){var m=n.value;b.set(m.getData(),e);e+=m.getSize()}}catch(l){h.e(l)}finally{h.f()}g.push(k)}}return g.length?new Uint8Array(b.buffer,0,this.mp4track.len):
null}},{key:"parseSPS",value:function(b){this.mp4track.sps=[new Uint8Array(b)];b=U.removeEmulationPreventionBytes(b);b=U.readSPS(new Uint8Array(b));this.mp4track.fps=b.fps||this.mp4track.fps;this.mp4track.width=b.width;this.mp4track.height=b.height;this.mp4track.codec="hvc1."+(b.profile_space?String.fromCharCode(64+b.profile_space):"")+b.profile_idc+"."+F(b.profile_compatibility_flags).toString(16)+"."+(b.tier_flag?"H":"L")+b.level_idc+"."+b.constraint_indicator_flags.map(function(e){return e.toString(16)}).join(".").toUpperCase().replace(/(?:\.0)+$/,
"");this.mp4track.hvcC={profile_space:b.profile_space,tier_flag:b.tier_flag,profile_idc:b.profile_idc,profile_compatibility_flags:b.profile_compatibility_flags,constraint_indicator_flags:b.constraint_indicator_flags,level_idc:b.level_idc,chroma_format_idc:b.chroma_format_idc}}},{key:"parsePPS",value:function(b){this.mp4track.pps=[b]}},{key:"parseVPS",value:function(b){this.mp4track.vps=[b]}},{key:"parseNAL",value:function(b){if(!b)return!1;if(b.isVCL)return!0;var e=!1;switch(b.type()){case C.VPS:this.mp4track.vps||
this.parseVPS(b.getPayload());e=!0;break;case C.SPS:this.mp4track.sps||this.parseSPS(b.getPayload());e=!0;break;case C.PPS:this.mp4track.pps||this.parsePPS(b.getPayload());e=!0;break;case C.AUD:q("AUD - ignoing");break;case C.SEI:case C.SEI2:q("SEI - ignoing")}!this.readyToDecode&&this.mp4track.vps&&this.mp4track.sps&&this.mp4track.pps&&(this.readyToDecode=!0);return e}}]);return a}(E),ja=function(c){function a(b,e,g,f){u(this,a);var h=d.call(this,"remuxer");h.videoCodec=g;h.frameDuration=f;h.initialized=
!1;h.tracks={};h.seq=1;h.env=b;h.timescale=1E3;h.mediaDuration=e?4294967295:0;return h}B(a,c);var d=A(a);v(a,[{key:"addTrack",value:function(b){var e=this;if(b==="video"||b==="both")this.tracks.video=this.videoCodec=="H265"?new ia(this.timescale,this.mediaDuration,this.frameDuration):new fa(this.timescale,this.mediaDuration,this.frameDuration),this.tracks.video.on("outOfData",function(){e.dispatch("missingVideoFrames")}),this.tracks.video.on("keyframePosition",function(g){e.dispatch("keyframePosition",
g)});if(b==="audio"||b==="both")b=new ea(this.timescale,this.mediaDuration,this.frameDuration),this.tracks.audio=b,this.tracks.video.on("outOfData",function(){e.dispatch("missingAudioFrames")})}},{key:"reset",value:function(){for(var b in this.tracks)this.tracks[b].resetTrack();this.initialized=!1}},{key:"destroy",value:function(){this.tracks={};this.offAll()}},{key:"flush",value:function(){if(!this.initialized){if(!this.isReady())return;this.dispatch("ready");this.initSegment();this.initialized=
!0}for(var b in this.tracks){var e=this.tracks[b],g=e.getPayload();if(g&&g.byteLength){var f=L.moof(this.seq,e.dts,e.mp4track);g=L.mdat(g);f=J(f,g);f={type:b,payload:f,dts:e.dts};b==="video"&&(f.fps=e.mp4track.fps);this.dispatch("buffer",f);var h="";var k=Math.floor(e.dts/this.timescale);g=parseInt(k/3600,10)%24;f=parseInt(k/60,10)%60;k=k<0?0:k%60;g>0&&(h+=(g<10?"0"+g:g)+":");f=h+((f<10?"0"+f:f)+":"+(k<10?"0"+k:k));q("put segment (".concat(b,"): dts: ").concat(e.dts," frames: ").concat(e.mp4track.samples.length,
" second: ").concat(f));e.flush();this.seq++}}}},{key:"initSegment",value:function(){var b=[],e;for(e in this.tracks){var g=this.tracks[e];this.env=="browser"?(g={type:e,payload:L.initSegment([g.mp4track],this.mediaDuration,this.timescale)},this.dispatch("buffer",g)):b.push(g.mp4track)}this.env=="node"&&(b={type:"all",payload:L.initSegment(b,this.mediaDuration,this.timescale)},this.dispatch("buffer",b));q("Initial segment generated.")}},{key:"isReady",value:function(){for(var b in this.tracks)if(!this.tracks[b].readyToDecode||
!this.tracks[b].samples.length)return!1;return!0}},{key:"feed",value:function(b){var e=!1;b.video&&this.tracks.video&&(e|=this.tracks.video.feed(b.video,b.duration,b.compositionTimeOffset));b.audio&&this.tracks.audio&&(e|=this.tracks.audio.feed(b.audio,b.duration));e?this.flush():x("Input object must have video and/or audio property. Make sure it is a valid typed array")}}]);return a}(K),ka=function(c){function a(b,e){u(this,a);var g=d.call(this,"buffer");g.type=e;g.queue=new Uint8Array;g.cleaning=
!1;g.pendingCleaning=0;g.cleanOffset=30;g.cleanRanges=[];g.sourceBuffer=b;g.sourceBuffer.addEventListener("updateend",function(){g.pendingCleaning>0&&(g.initCleanup(g.pendingCleaning),g.pendingCleaning=0);g.cleaning=!1;g.cleanRanges.length&&g.doCleanup()});g.sourceBuffer.addEventListener("error",function(){g.dispatch("error",{type:g.type,name:"buffer",error:"buffer error"})});return g}B(a,c);var d=A(a);v(a,[{key:"destroy",value:function(){this.sourceBuffer=this.queue=null;this.offAll()}},{key:"doCleanup",
value:function(){if(this.cleanRanges.length){var b=this.cleanRanges.shift();q("".concat(this.type," remove range [").concat(b[0]," - ").concat(b[1],")"));this.cleaning=!0;this.sourceBuffer.remove(b[0],b[1])}else this.cleaning=!1}},{key:"initCleanup",value:function(b){try{if(this.sourceBuffer.updating)this.pendingCleaning=b;else if(this.sourceBuffer.buffered&&this.sourceBuffer.buffered.length&&!this.cleaning){for(var e=0;e<this.sourceBuffer.buffered.length;++e){var g=this.sourceBuffer.buffered.start(e),
f=this.sourceBuffer.buffered.end(e);b-g>this.cleanOffset&&(f=b-this.cleanOffset,g<f&&this.cleanRanges.push([g,f]))}this.doCleanup()}}catch(h){x("Error occured while cleaning ".concat(this.type," buffer - ").concat(h.name,": ").concat(h.message))}}},{key:"doAppend",value:function(){if(this.queue.length&&this.sourceBuffer&&!this.sourceBuffer.updating)try{this.sourceBuffer.appendBuffer(this.queue),this.queue=new Uint8Array}catch(e){if(e.name==="QuotaExceededError"){q("".concat(this.type," buffer quota full"));
var b="QuotaExceeded"}else x("Error occured while appending ".concat(this.type," buffer - ").concat(e.name,": ").concat(e.message)),b="InvalidStateError";this.dispatch("error",{type:this.type,name:b,error:"buffer error"})}}},{key:"feed",value:function(b){this.queue=J(this.queue,b)}}]);return a}(K);return function(c){function a(b){u(this,a);var e=d.call(this,"jmuxer");e.isReset=!1;e.options=Object.assign({},{node:"",mode:"both",videoCodec:"H264",flushingTime:500,maxDelay:500,clearBuffer:!0,fps:30,
readFpsFromTrack:!1,debug:!1,onReady:function(){},onData:function(){},onError:function(){},onUnsupportedCodec:function(){},onMissingVideoFrames:function(){},onMissingAudioFrames:function(){},onKeyframePosition:function(){},onLoggerLog:console.log,onLoggerErr:console.error},b);e.env=(typeof process==="undefined"?"undefined":R(process))==="object"&&typeof window==="undefined"?"node":"browser";e.options.debug&&ba(e.options.onLoggerLog,e.options.onLoggerErr);e.options.fps||(e.options.fps=30);e.frameDuration=
1E3/e.options.fps|0;e.remuxController=new ja(e.env,b.live,e.options.videoCodec,e.frameDuration);e.remuxController.addTrack(e.options.mode);e.initData();e.remuxController.on("buffer",e.onBuffer.bind(O(e)));e.env=="browser"&&(e.remuxController.on("ready",e.createBuffer.bind(O(e))),e.initBrowser());e.remuxController.on("missingVideoFrames",function(){typeof e.options.onMissingVideoFrames==="function"&&e.options.onMissingVideoFrames.call(null)});e.remuxController.on("missingAudioFrames",function(){typeof e.options.onMissingAudioFrames===
"function"&&e.options.onMissingAudioFrames.call(null)});if(e.clearBuffer)e.remuxController.on("keyframePosition",function(g){e.kfPosition.push(g)});if(typeof e.options.onKeyframePosition==="function")e.remuxController.on("keyframePosition",function(g){e.options.onKeyframePosition.call(null,g)});return e}B(a,c);var d=A(a);v(a,[{key:"initData",value:function(){this.lastCleaningTime=Date.now();this.kfPosition=[];this.pendingUnits={};this.remainingData=new Uint8Array;this.startInterval()}},{key:"initBrowser",
value:function(){typeof this.options.node==="string"&&this.options.node==""&&x("no video element were found to render, provide a valid video element");this.node=typeof this.options.node==="string"?document.getElementById(this.options.node):this.options.node;this.mseReady=!1;this.setupMSE()}},{key:"createStream",value:function(){var b=this.feed.bind(this),e=this.destroy.bind(this);return this.stream=new D.Duplex({writableObjectMode:!0,read:function(g){},write:function(g,f,h){b(g);h()},"final":function(g){e();
g()}})}},{key:"setupMSE",value:function(){window.MediaSource=window.MediaSource||window.WebKitMediaSource||window.ManagedMediaSource;if(!window.MediaSource)throw"Oops! Browser does not support Media Source Extension or Managed Media Source (IOS 17+).";this.isMSESupported=!!window.MediaSource;this.mediaSource=new window.MediaSource;this.url=URL.createObjectURL(this.mediaSource);if(window.MediaSource===window.ManagedMediaSource)try{this.node.removeAttribute("src");this.node.disableRemotePlayback=!0;
var b=document.createElement("source");b.type="video/mp4";b.src=this.url;this.node.appendChild(b);this.node.load()}catch(e){this.node.src=this.url}else this.node.src=this.url;this.mseEnded=!1;this.mediaSource.addEventListener("sourceopen",this.onMSEOpen.bind(this));this.mediaSource.addEventListener("sourceclose",this.onMSEClose.bind(this));this.mediaSource.addEventListener("webkitsourceopen",this.onMSEOpen.bind(this));this.mediaSource.addEventListener("webkitsourceclose",this.onMSEClose.bind(this))}},
{key:"endMSE",value:function(){if(!this.mseEnded)try{this.mseEnded=!0,this.mediaSource.endOfStream()}catch(b){x("mediasource is not available to end")}}},{key:"feed",value:function(b){b&&this.remuxController&&(b.duration=b.duration?parseInt(b.duration):0,this.remuxController.feed(b))}},{key:"destroy",value:function(){this.stopInterval();this.stream&&(this.remuxController.flush(),this.stream.push(null),this.stream=null);this.remuxController&&(this.remuxController.destroy(),this.remuxController=null);
if(this.bufferControllers){for(var b in this.bufferControllers)this.bufferControllers[b].destroy();this.bufferControllers=null;this.endMSE()}this.videoStarted=this.mseReady=this.node=!1;this.mediaSource=null}},{key:"reset",value:function(){this.stopInterval();this.isReset=!0;this.node.pause();this.remuxController&&this.remuxController.reset();if(this.bufferControllers){for(var b in this.bufferControllers)this.bufferControllers[b].destroy();this.bufferControllers=null;this.endMSE()}this.initData();
this.env=="browser"&&this.initBrowser();q("JMuxer was reset")}},{key:"createBuffer",value:function(){if(this.mseReady&&this.remuxController&&this.remuxController.isReady()&&!this.bufferControllers){this.bufferControllers={};for(var b in this.remuxController.tracks){var e=this.remuxController.tracks[b];if(!a.isSupported("".concat(b,'/mp4; codecs="').concat(e.mp4track.codec,'"')))return x("Browser does not support codec: ".concat(b,'/mp4; codecs="').concat(e.mp4track.codec,'"')),typeof this.options.onUnsupportedCodec===
"function"&&this.options.onUnsupportedCodec.call(null,e.mp4track.codec),!1;e=this.mediaSource.addSourceBuffer("".concat(b,'/mp4; codecs="').concat(e.mp4track.codec,'"'));this.bufferControllers[b]=new ka(e,b);this.bufferControllers[b].on("error",this.onBufferError.bind(this))}}}},{key:"startInterval",value:function(){var b=this;this.interval=setInterval(function(){b.options.flushingTime?b.applyAndClearBuffer():b.bufferControllers&&b.cancelDelay()},this.options.flushingTime||1E3)}},{key:"stopInterval",
value:function(){this.interval&&clearInterval(this.interval)}},{key:"cancelDelay",value:function(){if(this.node.buffered&&this.node.buffered.length>0&&!this.node.seeking){var b=this.node.buffered.end(0);if(b-this.node.currentTime>this.options.maxDelay/1E3){q("delay");if(this.node.paused)this.node.play()["catch"](x);this.node.currentTime=b-.001}}}},{key:"releaseBuffer",value:function(){for(var b in this.bufferControllers)this.bufferControllers[b].doAppend()}},{key:"applyAndClearBuffer",value:function(){this.bufferControllers&&
(this.releaseBuffer(),this.clearBuffer())}},{key:"getSafeClearOffsetOfBuffer",value:function(b){for(var e=this.options.mode==="audio"&&b||0,g,f=0;f<this.kfPosition.length&&!(this.kfPosition[f]>=b);f++)g=this.kfPosition[f];g&&(this.kfPosition=this.kfPosition.filter(function(h){h<g&&(e=h);return h>=g}));return e}},{key:"clearBuffer",value:function(){if(this.options.clearBuffer&&Date.now()-this.lastCleaningTime>1E4){for(var b in this.bufferControllers){var e=this.getSafeClearOffsetOfBuffer(this.node.currentTime);
this.bufferControllers[b].initCleanup(e)}this.lastCleaningTime=Date.now()}}},{key:"onBuffer",value:function(b){this.options.readFpsFromTrack&&typeof b.fps!=="undefined"&&this.options.fps!=b.fps&&(this.options.fps=b.fps,this.frameDuration=Math.ceil(1E3/b.fps),q("JMuxer changed FPS to ".concat(b.fps," from track data")));this.env=="browser"?this.bufferControllers&&this.bufferControllers[b.type]&&this.bufferControllers[b.type].feed(b.payload):this.stream&&this.stream.push(b.payload);if(this.options.onData)this.options.onData(b.payload);
this.options.flushingTime===0&&this.applyAndClearBuffer()}},{key:"onMSEOpen",value:function(){this.mseReady=!0;URL.revokeObjectURL(this.url);typeof this.options.onReady==="function"&&this.options.onReady.call(null,this.isReset)}},{key:"onMSEClose",value:function(){this.videoStarted=this.mseReady=!1}},{key:"onBufferError",value:function(b){b.name=="QuotaExceeded"?(q("JMuxer cleaning ".concat(b.type," buffer due to QuotaExceeded error")),this.bufferControllers[b.type].initCleanup(this.node.currentTime)):
(b.name=="InvalidStateError"?(q("JMuxer is reseting due to InvalidStateError"),this.reset()):this.endMSE(),typeof this.options.onError==="function"&&this.options.onError.call(null,b))}}],[{key:"isSupported",value:function(b){return window.MediaSource&&window.MediaSource.isTypeSupported(b)}}]);return a}(K)});
